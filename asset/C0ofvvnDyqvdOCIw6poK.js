import{q as x,o as $,f as l,a2 as U,j as a,C as B}from"./YuA7MKX-N8BBDZOAxa77.js";import{m as G}from"./2R3b5JQuKIu9ouzzfEUO.js";import"./DMaOWi_7BvjHR9OOcqbD.js";import{u as W}from"./LiJY25P-VFx-37gB8DfS.js";import{u as K}from"./DMCex30FeWvvThtDj-pY.js";import{M as A}from"./CiW7RIy8_7rKRg9LP8yw.js";import{d as Y}from"./fynzmAtJ_PmpHXIxRwqH.js";import"./DnUuIl_qQ9_BDdjeE4Hc.js";import"./BUjYG6qMQjp0KnokeClt.js";import{S as z}from"./b9QDabEUvKe6AI27JKho.js";import{I as J}from"./5aiE5jUjBMeUbLP8QDw7.js";import{I as X}from"./Dk8w3hWGVSKEKYDngyKi.js";import{A as Q}from"./DQq4TAitTOKjRhP-XZH8.js";import{A as V}from"./D_tW9gMDolPU8kSJ3p7I.js";import{M as Z}from"./Bvuy4VUfZn7l94UnWCqM.js";import{M as ee}from"./CGyTUVgp8ujtB-5kZQZp.js";const te=x.div`
	padding: 0 16px;
	margin-bottom: 25px;
`,ne=x.div`
	background-color: var(--background-primary);
	padding: 0 16px;
	border-radius: 10px;
	display: flex;
	flex-direction: column;
`,oe=x.div`
	display: flex;
	flex-direction: row;
`,se=x.div`
	flex: 0 0 auto;
	position: sticky;
`,re=x.div`
	height: 45px;
	display: flex;
	justify-content: center;
	align-items: center;
`;function ae({channel:r}){var T;const u=W(),E=K("MessageInput"),[p,y]=l.useState(""),[i,f]=l.useState([]),[b,C]=l.useState(!1),h=l.useRef(null),[c,j]=l.useState(null),v=l.useCallback(Y(()=>r.stopTyping(),1e4),[r]),M=l.useCallback(()=>!(!i.length&&(!p||!p.trim()||!p.replace(/\r?\n|\r/g,""))),[i,p]),k=l.useCallback(e=>{const s=/:(\w+):/g;return e.replace(s,(n,t)=>{const o=Array.from(u.emojis.all.values()).find(m=>m.name===t);return o?`<:${t}:${o.id}>`:n})},[u.emojis]),R=l.useCallback(async()=>{r.stopTyping();const e=u.experiments.isTreatmentEnabled("message_queue",2),s=!u.experiments.isTreatmentEnabled("message_queue",1);if(!M()&&!e)return;const n=k(p),t=n,o=i;y(""),f([]),v(!0);const m=z.generate(),g=u.queue.add({id:m,content:t,files:o,author:u.account.raw,channel_id:r.id,guild_id:r.guildId,timestamp:new Date().toISOString(),type:U.Default});if(s)try{let d;if(o.length>0){const S=new FormData;S.append("payload_json",JSON.stringify({content:n,nonce:m})),o.forEach((H,L)=>{S.append(`files[${L}]`,H)}),d=S}else d={content:n,nonce:m};await r.sendMessage(d,g)}catch(d){const S=d instanceof Error?d.message:typeof d=="string"?d:"Unknown error";g.fail(S)}else e&&g.fail("Message queue experiment")},[p,i,r,M]),w=e=>{e.ctrlKey&&e.key==="Enter"&&(e.preventDefault(),R()),!e.shiftKey&&e.key==="Enter"&&(e.preventDefault(),R()),e.key==="Escape"&&i.length>0&&f([]),v(!0)},I=e=>{y(e),r.startTyping()},N=e=>{if(e.length!==0){if(e.length>A||i.length+e.length>A){G.push({type:"error",title:"Too many attachments",error:`You can only attach ${A} files at once.`});return}f(s=>[...s,...e])}},O=()=>{y("")},D=()=>{const e=document.querySelector('[contenteditable="true"]');if(e){e.focus();const s=window.getSelection();if(s&&s.rangeCount>0){const n=s.getRangeAt(0);j({startContainer:n.startContainer,startOffset:n.startOffset,endContainer:n.endContainer,endOffset:n.endOffset})}}C(s=>!s)},_=e=>{if(!e)return;const s=document.querySelector('[contenteditable="true"]');if(!s)return;if(e.isCustom&&e.imageUrl){const t=Array.from(u.emojis.all.values()).find(o=>o.name===e.names[0]);if(t){const o=document.createElement("img");o.className="emoji",o.src=t.imageUrl,o.alt=t.name,o.title=t.name,o.setAttribute("data-emoji-name",t.name),o.setAttribute("data-emoji-id",t.id),q(s,o)}}else P(s,e.emoji);const n=F(s.innerHTML);y(n),C(!1),r.startTyping()},q=(e,s)=>{e.focus();const n=window.getSelection();if(c&&n)try{const t=document.createRange();t.setStart(c.startContainer,c.startOffset),t.setEnd(c.endContainer,c.endOffset),n.removeAllRanges(),n.addRange(t)}catch(t){E.warn("Failed to restore saved selection:",t);const o=document.createRange();o.selectNodeContents(e),o.collapse(!1),n.removeAllRanges(),n.addRange(o)}if(n&&n.rangeCount>0){const t=n.getRangeAt(0);return t.deleteContents(),t.insertNode(s),t.setStartAfter(s),t.collapse(!0),n.removeAllRanges(),n.addRange(t),j(null),!0}return!1},P=(e,s)=>{e.focus();const n=window.getSelection();if(c&&n)try{const t=document.createRange();t.setStart(c.startContainer,c.startOffset),t.setEnd(c.endContainer,c.endOffset),n.removeAllRanges(),n.addRange(t)}catch(t){E.warn("Failed to restore saved selection:",t);const o=document.createRange();o.selectNodeContents(e),o.collapse(!1),n.removeAllRanges(),n.addRange(o)}if(n&&n.rangeCount>0){const t=n.getRangeAt(0);t.deleteContents();const o=document.createTextNode(s);return t.insertNode(o),t.collapse(!1),n.removeAllRanges(),n.addRange(t),j(null),!0}return!1},F=e=>{const s=document.createElement("div");return s.innerHTML=e,s.querySelectorAll("img.emoji").forEach(t=>{var m;const o=t.getAttribute("data-emoji-name");if(o){const g=document.createTextNode(`:${o}:`);(m=t.parentNode)==null||m.replaceChild(g,t)}}),s.innerHTML=s.innerHTML.replace(/<br>/g,`
`),s.textContent||""};return a.jsx(te,{children:a.jsxs(ne,{children:[a.jsx(V,{attachments:i,remove:e=>{i.length!==0&&(i.length===1?f([]):f(i.filter((s,n)=>n!==e)))}}),a.jsxs(oe,{children:[a.jsx(se,{children:r.hasPermission("ATTACH_FILES")&&r.hasPermission("SEND_MESSAGES")&&a.jsx(Q,{append:N,clearInput:O})}),a.jsx(ee,{id:"messageinput",value:p,placeholder:r.hasPermission("SEND_MESSAGES")?`Message ${r.type===B.DM?(T=r.recipients)==null?void 0:T[0].username:"#"+r.name}`:"You do not have permission to send messages in this channel.",disabled:!r.hasPermission("SEND_MESSAGES"),onChange:I,onKeyDown:w}),r.hasPermission("SEND_MESSAGES")&&a.jsxs(a.Fragment,{children:[a.jsx(re,{children:a.jsx(X,{ref:h,onClick:D,children:a.jsx(J,{icon:"mdiStickerEmoji",size:"24px",color:"var(--text)"})})}),a.jsx(Z,{isOpen:b,onClose:()=>C(!1),buttonRef:h,onEmojiSelect:_})]})]})]})})}const he=$(ae);export{he as M};
